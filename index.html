<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEMB Studio - Cliente Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #d32f2f;
            margin-bottom: 20px;
            border-bottom: 2px solid #d32f2f;
            padding-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card h2 {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.5rem;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
        }
        button:hover {
            background: #b71c1c;
        }
        button.secondary {
            background: #555;
        }
        button.secondary:hover {
            background: #333;
        }
        .response {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .item-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .item-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #d32f2f;
        }
        .item-card.selected {
            border: 3px solid #d32f2f;
            background: #ffebee;
        }
        .item-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .item-card p {
            color: #666;
            font-size: 0.9rem;
        }
        .badge {
            background: #d32f2f;
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            margin-right: 5px;
        }
        .flex {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .flex > * {
            flex: 1 1 300px;
        }
        .hidden {
            display: none;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #eee;
            border-radius: 4px;
            margin: 0 5px;
            font-weight: 600;
        }
        .step.active {
            background: #d32f2f;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèéÔ∏è OEMB Studio - Cliente Web</h1>

        <!-- Estado actual del proyecto -->
        <div class="card">
            <h2>Proyecto actual</h2>
            <div class="form-group">
                <label for="projectId">ID del proyecto (crea uno nuevo si no tienes)</label>
                <div class="flex">
                    <input type="text" id="projectId" placeholder="Ej: 1">
                    <button onclick="loadProject()">Cargar proyecto</button>
                    <button onclick="createProject()" class="secondary">Crear nuevo proyecto</button>
                </div>
            </div>
            <div id="projectInfo" class="response hidden"></div>
        </div>

        <!-- Indicador de pasos (flujo) -->
        <div class="card">
            <h2>Flujo de producci√≥n</h2>
            <div class="step-indicator" id="stepIndicator">
                <div class="step" id="step1">1. Crear proyecto</div>
                <div class="step" id="step2">2. Generar t√≠tulos</div>
                <div class="step" id="step3">3. Seleccionar t√≠tulo</div>
                <div class="step" id="step4">4. Generar copias</div>
                <div class="step" id="step5">5. Seleccionar copia</div>
                <div class="step" id="step6">6. Ver resultado</div>
            </div>
        </div>

        <!-- Panel principal -->
        <div class="grid">
            <!-- Columna izquierda: acciones -->
            <div class="card">
                <h2>Acciones r√°pidas</h2>
                <button onclick="generateTitles()" style="width:100%; margin-bottom:10px;">üéØ Generar t√≠tulos</button>
                <button onclick="generateThumbnails()" style="width:100%; margin-bottom:10px;">üñºÔ∏è Generar copias de miniatura</button>
                <button onclick="generateDescription()" style="width:100%; margin-bottom:10px;">üìù Generar descripci√≥n</button>
                <button onclick="generateTags()" style="width:100%; margin-bottom:10px;">üè∑Ô∏è Generar tags</button>
                <button onclick="generateImagePrompt()" style="width:100%; margin-bottom:10px;">üé® Generar prompt de imagen</button>
                <button onclick="startWorkflow()" style="width:100%; margin-bottom:10px;">‚öôÔ∏è Iniciar flujo</button>
                <button onclick="nextStep()" style="width:100%;">‚è© Siguiente paso (si hay flujo activo)</button>
            </div>

            <!-- Columna derecha: resultados -->
            <div class="card">
                <h2>Resultados</h2>
                <div id="results" class="response">Aqu√≠ aparecer√°n los resultados de las operaciones.</div>
            </div>
        </div>

        <!-- Secci√≥n para t√≠tulos generados -->
        <div class="card" id="titlesSection" style="display:none;">
            <h2>T√≠tulos sugeridos</h2>
            <div id="titlesList" class="grid"></div>
            <div class="form-group" style="margin-top:20px;">
                <label for="selectedTitleId">ID del t√≠tulo seleccionado</label>
                <input type="text" id="selectedTitleId" placeholder="Ej: 1">
                <button onclick="selectTitle()" style="margin-top:10px;">Confirmar selecci√≥n</button>
            </div>
        </div>

        <!-- Secci√≥n para copias de miniatura -->
        <div class="card" id="thumbnailsSection" style="display:none;">
            <h2>Copias de miniatura sugeridas</h2>
            <div id="thumbnailsList" class="grid"></div>
            <div class="form-group" style="margin-top:20px;">
                <label for="selectedThumbnailId">ID de la copia seleccionada</label>
                <input type="text" id="selectedThumbnailId" placeholder="Ej: 1">
                <button onclick="selectThumbnail()" style="margin-top:10px;">Confirmar selecci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentProjectId = null;
        let currentWorkflowInstanceId = null;
        let currentStep = null;

        // Funci√≥n para hacer peticiones a la API
        async function apiCall(endpoint, method = 'GET', body = null) {
            const url = `http://localhost:8000${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Mostrar resultados en el panel
        function showResult(data) {
            document.getElementById('results').innerHTML = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        // Mostrar error
        function showError(error) {
            document.getElementById('results').innerHTML = `<span style="color:red;">‚ùå Error: ${error.message}</span>`;
        }

        // Actualizar paso activo en el indicador
        function updateStep(step) {
            currentStep = step;
            for (let i = 1; i <= 6; i++) {
                const el = document.getElementById(`step${i}`);
                if (i === step) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            }
        }

        // Cargar proyecto
        async function loadProject() {
            const projectId = document.getElementById('projectId').value;
            if (!projectId) {
                alert('Ingresa un ID de proyecto');
                return;
            }
            try {
                const data = await apiCall(`/projects/${projectId}`);
                currentProjectId = projectId;
                document.getElementById('projectInfo').classList.remove('hidden');
                document.getElementById('projectInfo').innerHTML = JSON.stringify(data, null, 2);
                updateStep(1); // Proyecto cargado
                showResult('Proyecto cargado correctamente');
            } catch (e) {
                showError(e);
            }
        }

        // Crear nuevo proyecto
        async function createProject() {
            const userId = prompt('ID de usuario (ej: usuario1):', 'usuario1');
            const topic = prompt('Tema del video (ej: double diffuser Brawn GP):', 'double diffuser Brawn GP');
            const emotion = prompt('Emoci√≥n principal (ej: controversia):', 'controversia');
            const technicalLevel = prompt('Nivel t√©cnico (beginner/intermediate/advanced):', 'advanced');
            if (!userId || !topic) return;

            const body = {
                user_id: userId,
                topic,
                emotion,
                technical_level: technicalLevel
            };
            try {
                const data = await apiCall('/projects/', 'POST', body);
                currentProjectId = data.id;
                document.getElementById('projectId').value = data.id;
                document.getElementById('projectInfo').classList.remove('hidden');
                document.getElementById('projectInfo').innerHTML = JSON.stringify(data, null, 2);
                updateStep(1);
                showResult('Proyecto creado: ID ' + data.id);
            } catch (e) {
                showError(e);
            }
        }

        // Generar t√≠tulos
        async function generateTitles() {
            if (!currentProjectId) {
                alert('Primero carga o crea un proyecto');
                return;
            }
            const topic = prompt('Tema para generar t√≠tulos (deja vac√≠o para usar el del proyecto):', '');
            const categoryId = prompt('ID de categor√≠a (opcional, 1 para Racing Tech):', '1');
            const emotions = prompt('Emociones separadas por coma (ej: controversia,admiraci√≥n):', 'controversia');
            const emotionsArray = emotions.split(',').map(e => e.trim());

            const body = {
                topic: topic || undefined,
                category_id: categoryId ? parseInt(categoryId) : undefined,
                target_emotions: emotionsArray,
                technical_level: 'advanced'
            };
            try {
                const data = await apiCall('/titles/generate', 'POST', body);
                showResult(data);
                // Mostrar la secci√≥n de t√≠tulos
                const titlesSection = document.getElementById('titlesSection');
                titlesSection.style.display = 'block';
                const titlesList = document.getElementById('titlesList');
                titlesList.innerHTML = '';
                data.forEach((title, index) => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.onclick = () => {
                        document.getElementById('selectedTitleId').value = title.pattern_id; // o title.id si existiera
                        // Marcar visualmente
                        document.querySelectorAll('#titlesList .item-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    };
                    card.innerHTML = `
                        <h3>${title.generated_variant}</h3>
                        <p><strong>Patr√≥n:</strong> ${title.pattern_name}</p>
                        <p><strong>CTR estimado:</strong> ${title.estimated_ctr}</p>
                        <p><strong>Multiplicador:</strong> ${title.avg_multiplier}x</p>
                        <p><strong>Triggers:</strong> ${title.psychological_triggers.join(', ')}</p>
                        <p><strong>Ejemplos:</strong> ${title.examples.join(' | ')}</p>
                    `;
                    titlesList.appendChild(card);
                });
                updateStep(2);
            } catch (e) {
                showError(e);
            }
        }

        // Seleccionar t√≠tulo
        async function selectTitle() {
            const titleId = document.getElementById('selectedTitleId').value;
            if (!currentProjectId || !titleId) {
                alert('Falta proyecto o ID de t√≠tulo');
                return;
            }
            try {
                const data = await apiCall('/titles/select', 'POST', {
                    project_id: parseInt(currentProjectId),
                    title_id: parseInt(titleId)
                });
                showResult(data);
                updateStep(3);
                // Ocultar secci√≥n de t√≠tulos
                document.getElementById('titlesSection').style.display = 'none';
            } catch (e) {
                showError(e);
            }
        }

        // Generar copias de miniatura
        async function generateThumbnails() {
            if (!currentProjectId) {
                alert('Primero carga un proyecto');
                return;
            }
            const categoryId = prompt('ID de categor√≠a:', '1');
            const emotion = prompt('Emoci√≥n:', 'controversia');
            const titleText = prompt('Texto del t√≠tulo (puedes copiarlo de la lista anterior):', '');

            const body = {
                project_id: parseInt(currentProjectId),
                category_id: parseInt(categoryId),
                emotion,
                title_text: titleText
            };
            try {
                const data = await apiCall('/thumbnails/generate', 'POST', body);
                showResult(data);
                // Mostrar secci√≥n de thumbnails
                const thumbSection = document.getElementById('thumbnailsSection');
                thumbSection.style.display = 'block';
                const thumbList = document.getElementById('thumbnailsList');
                thumbList.innerHTML = '';
                data.forEach((thumb, index) => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.onclick = () => {
                        document.getElementById('selectedThumbnailId').value = thumb.id;
                        document.querySelectorAll('#thumbnailsList .item-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    };
                    card.innerHTML = `
                        <h3>${thumb.text}</h3>
                        <p><strong>Colocaci√≥n:</strong> ${thumb.placement || 'N/A'}</p>
                        <p><strong>Colores:</strong> ${thumb.color_scheme || 'N/A'}</p>
                        <p><strong>Legibilidad:</strong> ${thumb.readability_score}</p>
                        <p><strong>Ideal para:</strong> ${thumb.best_for || 'N/A'}</p>
                    `;
                    thumbList.appendChild(card);
                });
                updateStep(4);
            } catch (e) {
                showError(e);
            }
        }

        // Seleccionar copia de miniatura
        async function selectThumbnail() {
            const thumbId = document.getElementById('selectedThumbnailId').value;
            if (!currentProjectId || !thumbId) {
                alert('Falta proyecto o ID de copia');
                return;
            }
            try {
                const data = await apiCall(`/thumbnails/select?project_id=${currentProjectId}&thumbnail_copy_id=${thumbId}`, 'POST');
                showResult(data);
                updateStep(5);
                document.getElementById('thumbnailsSection').style.display = 'none';
            } catch (e) {
                showError(e);
            }
        }

        // Generar descripci√≥n (simplificado)
        async function generateDescription() {
            if (!currentProjectId) {
                alert('Primero carga un proyecto');
                return;
            }
            // Para simplificar, usamos datos de ejemplo
            const body = {
                category_id: 1,
                niche: 'Racing Tech',
                pattern_name: 'Tecnolog√≠a Prohibida',
                success_rate: 0.87,
                avg_multiplier: 18.5,
                chapters: [["00:00", "Introducci√≥n"], ["05:00", "An√°lisis"]],
                equipment: ["C√°mara Sony", "Micr√≥fono"],
                cta_text: "¬øQu√© opinas? Deja tu comentario."
            };
            try {
                const data = await apiCall('/descriptions/generate', 'POST', body);
                showResult(data);
            } catch (e) {
                showError(e);
            }
        }

        // Generar tags
        async function generateTags() {
            if (!currentProjectId) {
                alert('Primero carga un proyecto');
                return;
            }
            const titleText = prompt('Texto del t√≠tulo para generar tags:', '');
            const body = {
                category_id: 1,
                title_text: titleText,
                technical_specs: []
            };
            try {
                const data = await apiCall('/seo/tags/generate', 'POST', body);
                showResult(data);
            } catch (e) {
                showError(e);
            }
        }

        // Generar prompt de imagen
        async function generateImagePrompt() {
            if (!currentProjectId) {
                alert('Primero carga un proyecto');
                return;
            }
            // Esta funci√≥n solo genera el prompt, no llama a la API de imagen
            // Necesitar√≠amos tener el proyecto con t√≠tulo y thumbnail seleccionados
            alert('Esta funci√≥n requiere que el proyecto tenga t√≠tulo y miniatura seleccionados.\nPor ahora puedes obtener el prompt desde el proyecto con GET /projects/{id}');
        }

        // Iniciar flujo de trabajo
        async function startWorkflow() {
            if (!currentProjectId) {
                alert('Primero carga un proyecto');
                return;
            }
            try {
                const data = await apiCall('/workflows/start', 'POST', {
                    project_id: parseInt(currentProjectId)
                });
                currentWorkflowInstanceId = data.instance_id;
                showResult(data);
                updateStep(2); // Asumimos que el primer paso es generar t√≠tulos
            } catch (e) {
                showError(e);
            }
        }

        // Siguiente paso del flujo (simplificado, requerir√≠a inputs)
        async function nextStep() {
            if (!currentWorkflowInstanceId) {
                alert('Primero inicia un flujo');
                return;
            }
            // Esto es solo un placeholder, necesitar√≠as saber qu√© paso sigue y qu√© inputs pedir
            alert('Funcionalidad de flujo autom√°tico no implementada en este demo.\nUsa los botones individuales para avanzar.');
        }

        // Inicializar
        window.onload = () => {
            updateStep(1);
        };
    </script>
</body>
</html>